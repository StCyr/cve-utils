#!/usr/bin/perl
use strict;
use warnings;
use Text::CSV;

binmode STDOUT, ":encoding(UTF-8)";

# Open software inventory file
my $csv = Text::CSV->new({ binary => 1, escape_char => "\\" });
my $inventory = $ARGV[0];
open my $fh, "<", $inventory;

# Parse inventory
while (my $row = $csv->getline($fh)) {

  # Assign fields to variables
  my $vendor = ${$row}[0];
  my $soft = ${$row}[1];
  my $version = ${$row}[2];
  my $count = ${$row}[3];

  next unless ($soft);

  chomp( my $cpe = `./soft2cpe.pl --vendor "$vendor" "$soft"` );

  if ($cpe) {
     my ($cpe_vendor,$cpe_soft) = split(':',$cpe);
     my @cve;

     if ( $version ) {
       @cve = `./cve-search.pl --vendor $cpe_vendor --soft $cpe_soft --version $version --debug`;
     } else {
       @cve = `./cve-search.pl --vendor $cpe_vendor --soft $cpe_soft --debug`;
     }

     print "Found " . scalar @cve . " CVE for \"$soft\" version \"$version\" from \"$vendor\" with CPE name \"$cpe_vendor:$cpe_soft\" (Installed on $count computers):\n";
     print @cve; 

  } else {
     print "No CPE found for \"$soft\" from \"$vendor\"\n";
  } 
}
